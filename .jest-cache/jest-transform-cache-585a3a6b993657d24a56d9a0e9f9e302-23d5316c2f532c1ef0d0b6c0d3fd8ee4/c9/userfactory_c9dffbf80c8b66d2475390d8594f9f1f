ebbeb3074429efe461257229a64d3815
"use strict";
/**
 * Test User Factory
 * Creates test users with Supabase Auth tokens for testing
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.userFactory = exports.UserFactory = void 0;
const supabase_js_1 = require("@supabase/supabase-js");
const crypto_1 = require("crypto");
class UserFactory {
    constructor() {
        this.createdUsers = [];
        // Initialize Supabase clients
        this.supabaseAdmin = (0, supabase_js_1.createClient)(global.testConfig.supabaseUrl, global.testConfig.supabaseServiceKey, {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        });
        this.supabaseClient = (0, supabase_js_1.createClient)(global.testConfig.supabaseUrl, global.testConfig.supabaseAnonKey);
    }
    /**
     * Generate a secure random password
     */
    generatePassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        const bytes = (0, crypto_1.randomBytes)(16);
        for (let i = 0; i < 16; i++) {
            password += chars[bytes[i] % chars.length];
        }
        return password;
    }
    /**
     * Generate a test email address
     */
    generateEmail() {
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        return `test-${timestamp}-${random}@emapay.test`;
    }
    /**
     * Create a test user with authentication
     */
    async createUser(options = {}) {
        var _a;
        const email = options.email || this.generateEmail();
        const password = options.password || this.generatePassword();
        const emailConfirmed = options.emailConfirmed !== false; // Default to true
        try {
            // Create user using admin API
            const { data: adminData, error: adminError } = await this.supabaseAdmin.auth.admin.createUser({
                email,
                password,
                email_confirm: emailConfirmed,
                user_metadata: Object.assign({ name: `Test User ${Date.now()}`, purpose: 'API Testing', created_for_test: true }, options.metadata)
            });
            if (adminError) {
                throw new Error(`Failed to create user: ${adminError.message}`);
            }
            // Sign in as the user to get session tokens
            const { data: signInData, error: signInError } = await this.supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            if (signInError) {
                throw new Error(`Failed to sign in user: ${signInError.message}`);
            }
            if (!((_a = signInData.session) === null || _a === void 0 ? void 0 : _a.access_token)) {
                throw new Error('No access token received from sign in');
            }
            const testUser = {
                id: adminData.user.id,
                email,
                password,
                accessToken: signInData.session.access_token,
                refreshToken: signInData.session.refresh_token,
                sessionId: signInData.session.user.id, // Use user ID as session identifier
                createdAt: new Date().toISOString()
            };
            // Track created user for cleanup
            this.createdUsers.push(testUser);
            return testUser;
        }
        catch (error) {
            throw new Error(`User creation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    /**
     * Create multiple test users
     */
    async createUsers(count, options = {}) {
        const users = [];
        for (let i = 0; i < count; i++) {
            const userOptions = Object.assign(Object.assign({}, options), { email: options.email ? `${i}-${options.email}` : undefined });
            const user = await this.createUser(userOptions);
            users.push(user);
        }
        return users;
    }
    /**
     * Refresh a user's access token
     */
    async refreshUserToken(user) {
        var _a;
        try {
            const { data, error } = await this.supabaseClient.auth.refreshSession({
                refresh_token: user.refreshToken
            });
            if (error) {
                throw new Error(`Token refresh failed: ${error.message}`);
            }
            if (!((_a = data.session) === null || _a === void 0 ? void 0 : _a.access_token)) {
                throw new Error('No access token received from refresh');
            }
            // Update user with new tokens
            user.accessToken = data.session.access_token;
            user.refreshToken = data.session.refresh_token;
            return user;
        }
        catch (error) {
            throw new Error(`Token refresh failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    /**
     * Delete a test user
     */
    async deleteUser(user) {
        try {
            const { error } = await this.supabaseAdmin.auth.admin.deleteUser(user.id);
            if (error) {
                console.warn(`Failed to delete user ${user.id}:`, error.message);
            }
            // Remove from tracking
            this.createdUsers = this.createdUsers.filter(u => u.id !== user.id);
        }
        catch (error) {
            console.warn(`Failed to delete user ${user.id}:`, error);
        }
    }
    /**
     * Clean up all created users
     */
    async cleanup() {
        console.log(`ðŸ§¹ Cleaning up ${this.createdUsers.length} test users...`);
        const deletePromises = this.createdUsers.map(user => this.deleteUser(user));
        await Promise.allSettled(deletePromises);
        this.createdUsers = [];
        console.log('âœ… User cleanup completed');
    }
    /**
     * Get all created users
     */
    getCreatedUsers() {
        return [...this.createdUsers];
    }
    /**
     * Create a user with specific wallet balances
     */
    async createUserWithBalance(eurBalance = 1000, aoaBalance = 500000, options = {}) {
        const user = await this.createUser(options);
        try {
            // Create wallets with initial balances
            await this.supabaseAdmin
                .from('wallets')
                .upsert([
                {
                    user_id: user.id,
                    currency: 'EUR',
                    available_balance: eurBalance,
                    reserved_balance: 0,
                    total_balance: eurBalance
                },
                {
                    user_id: user.id,
                    currency: 'AOA',
                    available_balance: aoaBalance,
                    reserved_balance: 0,
                    total_balance: aoaBalance
                }
            ]);
            console.log(`ðŸ’° Created user ${user.email} with EUR: ${eurBalance}, AOA: ${aoaBalance}`);
        }
        catch (error) {
            console.warn(`Failed to set wallet balances for user ${user.id}:`, error);
        }
        return user;
    }
}
exports.UserFactory = UserFactory;
// Export singleton instance
exports.userFactory = new UserFactory();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEb2N1bWVudHNcXEdpdEh1YlxcZW1hXFx0ZXN0c1xcdXRpbHNcXHVzZXItZmFjdG9yeS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCx1REFBcUQ7QUFDckQsbUNBQXFDO0FBbUJyQyxNQUFhLFdBQVc7SUFLdEI7UUFGUSxpQkFBWSxHQUFlLEVBQUUsQ0FBQztRQUdwQyw4QkFBOEI7UUFDOUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFBLDBCQUFZLEVBQy9CLE1BQU0sQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUM3QixNQUFNLENBQUMsVUFBVSxDQUFDLGtCQUFrQixFQUNwQztZQUNFLElBQUksRUFBRTtnQkFDSixnQkFBZ0IsRUFBRSxLQUFLO2dCQUN2QixjQUFjLEVBQUUsS0FBSzthQUN0QjtTQUNGLENBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBQSwwQkFBWSxFQUNoQyxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFDN0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSyxnQkFBZ0I7UUFDdEIsTUFBTSxLQUFLLEdBQUcsd0VBQXdFLENBQUM7UUFDdkYsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLE1BQU0sS0FBSyxHQUFHLElBQUEsb0JBQVcsRUFBQyxFQUFFLENBQUMsQ0FBQztRQUU5QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDNUIsUUFBUSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLENBQUM7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxhQUFhO1FBQ25CLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FB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Q0FBQztRQUUzRixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsMENBQTBDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM1RSxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUF6T0Qsa0NBeU9DO0FBRUQsNEJBQTRCO0FBQ2YsUUFBQSxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERvY3VtZW50c1xcR2l0SHViXFxlbWFcXHRlc3RzXFx1dGlsc1xcdXNlci1mYWN0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdCBVc2VyIEZhY3RvcnlcbiAqIENyZWF0ZXMgdGVzdCB1c2VycyB3aXRoIFN1cGFiYXNlIEF1dGggdG9rZW5zIGZvciB0ZXN0aW5nXG4gKi9cblxuaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAnQHN1cGFiYXNlL3N1cGFiYXNlLWpzJztcbmltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcblxuZXhwb3J0IGludGVyZmFjZSBUZXN0VXNlciB7XG4gIGlkOiBzdHJpbmc7XG4gIGVtYWlsOiBzdHJpbmc7XG4gIHBhc3N3b3JkOiBzdHJpbmc7XG4gIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gIHJlZnJlc2hUb2tlbjogc3RyaW5nO1xuICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JlYXRlVXNlck9wdGlvbnMge1xuICBlbWFpbD86IHN0cmluZztcbiAgcGFzc3dvcmQ/OiBzdHJpbmc7XG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgZW1haWxDb25maXJtZWQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgVXNlckZhY3Rvcnkge1xuICBwcml2YXRlIHN1cGFiYXNlQWRtaW46IGFueTtcbiAgcHJpdmF0ZSBzdXBhYmFzZUNsaWVudDogYW55O1xuICBwcml2YXRlIGNyZWF0ZWRVc2VyczogVGVzdFVzZXJbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIEluaXRpYWxpemUgU3VwYWJhc2UgY2xpZW50c1xuICAgIHRoaXMuc3VwYWJhc2VBZG1pbiA9IGNyZWF0ZUNsaWVudChcbiAgICAgIGdsb2JhbC50ZXN0Q29uZmlnLnN1cGFiYXNlVXJsLFxuICAgICAgZ2xvYmFsLnRlc3RDb25maWcuc3VwYWJhc2VTZXJ2aWNlS2V5LFxuICAgICAge1xuICAgICAgICBhdXRoOiB7XG4gICAgICAgICAgYXV0b1JlZnJlc2hUb2tlbjogZmFsc2UsXG4gICAgICAgICAgcGVyc2lzdFNlc3Npb246IGZhbHNlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5zdXBhYmFzZUNsaWVudCA9IGNyZWF0ZUNsaWVudChcbiAgICAgIGdsb2JhbC50ZXN0Q29uZmlnLnN1cGFiYXNlVXJsLFxuICAgICAgZ2xvYmFsLnRlc3RDb25maWcuc3VwYWJhc2VBbm9uS2V5XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIHNlY3VyZSByYW5kb20gcGFzc3dvcmRcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVQYXNzd29yZCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGNoYXJzID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5IUAjJCVeJionO1xuICAgIGxldCBwYXNzd29yZCA9ICcnO1xuICAgIGNvbnN0IGJ5dGVzID0gcmFuZG9tQnl0ZXMoMTYpO1xuICAgIFxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKykge1xuICAgICAgcGFzc3dvcmQgKz0gY2hhcnNbYnl0ZXNbaV0gJSBjaGFycy5sZW5ndGhdO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gcGFzc3dvcmQ7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgYSB0ZXN0IGVtYWlsIGFkZHJlc3NcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVFbWFpbCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgY29uc3QgcmFuZG9tID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDcpO1xuICAgIHJldHVybiBgdGVzdC0ke3RpbWVzdGFtcH0tJHtyYW5kb219QGVtYXBheS50ZXN0YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSB0ZXN0IHVzZXIgd2l0aCBhdXRoZW50aWNhdGlvblxuICAgKi9cbiAgYXN5bmMgY3JlYXRlVXNlcihvcHRpb25zOiBDcmVhdGVVc2VyT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxUZXN0VXNlcj4ge1xuICAgIGNvbnN0IGVtYWlsID0gb3B0aW9ucy5lbWFpbCB8fCB0aGlzLmdlbmVyYXRlRW1haWwoKTtcbiAgICBjb25zdCBwYXNzd29yZCA9IG9wdGlvbnMucGFzc3dvcmQgfHwgdGhpcy5nZW5lcmF0ZVBhc3N3b3JkKCk7XG4gICAgY29uc3QgZW1haWxDb25maXJtZWQgPSBvcHRpb25zLmVtYWlsQ29uZmlybWVkICE9PSBmYWxzZTsgLy8gRGVmYXVsdCB0byB0cnVlXG5cbiAgICB0cnkge1xuICAgICAgLy8gQ3JlYXRlIHVzZXIgdXNpbmcgYWRtaW4gQVBJXG4gICAgICBjb25zdCB7IGRhdGE6IGFkbWluRGF0YSwgZXJyb3I6IGFkbWluRXJyb3IgfSA9IGF3YWl0IHRoaXMuc3VwYWJhc2VBZG1pbi5hdXRoLmFkbWluLmNyZWF0ZVVzZXIoe1xuICAgICAgICBlbWFpbCxcbiAgICAgICAgcGFzc3dvcmQsXG4gICAgICAgIGVtYWlsX2NvbmZpcm06IGVtYWlsQ29uZmlybWVkLFxuICAgICAgICB1c2VyX21ldGFkYXRhOiB7XG4gICAgICAgICAgbmFtZTogYFRlc3QgVXNlciAke0RhdGUubm93KCl9YCxcbiAgICAgICAgICBwdXJwb3NlOiAnQVBJIFRlc3RpbmcnLFxuICAgICAgICAgIGNyZWF0ZWRfZm9yX3Rlc3Q6IHRydWUsXG4gICAgICAgICAgLi4ub3B0aW9ucy5tZXRhZGF0YVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgaWYgKGFkbWluRXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY3JlYXRlIHVzZXI6ICR7YWRtaW5FcnJvci5tZXNzYWdlfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBTaWduIGluIGFzIHRoZSB1c2VyIHRvIGdldCBzZXNzaW9uIHRva2Vuc1xuICAgICAgY29uc3QgeyBkYXRhOiBzaWduSW5EYXRhLCBlcnJvcjogc2lnbkluRXJyb3IgfSA9IGF3YWl0IHRoaXMuc3VwYWJhc2VDbGllbnQuYXV0aC5zaWduSW5XaXRoUGFzc3dvcmQoe1xuICAgICAgICBlbWFpbCxcbiAgICAgICAgcGFzc3dvcmRcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoc2lnbkluRXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gc2lnbiBpbiB1c2VyOiAke3NpZ25JbkVycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghc2lnbkluRGF0YS5zZXNzaW9uPy5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBhY2Nlc3MgdG9rZW4gcmVjZWl2ZWQgZnJvbSBzaWduIGluJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRlc3RVc2VyOiBUZXN0VXNlciA9IHtcbiAgICAgICAgaWQ6IGFkbWluRGF0YS51c2VyLmlkLFxuICAgICAgICBlbWFpbCxcbiAgICAgICAgcGFzc3dvcmQsXG4gICAgICAgIGFjY2Vzc1Rva2VuOiBzaWduSW5EYXRhLnNlc3Npb24uYWNjZXNzX3Rva2VuLFxuICAgICAgICByZWZyZXNoVG9rZW46IHNpZ25JbkRhdGEuc2Vzc2lvbi5yZWZyZXNoX3Rva2VuLFxuICAgICAgICBzZXNzaW9uSWQ6IHNpZ25JbkRhdGEuc2Vzc2lvbi51c2VyLmlkLCAvLyBVc2UgdXNlciBJRCBhcyBzZXNzaW9uIGlkZW50aWZpZXJcbiAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH07XG5cbiAgICAgIC8vIFRyYWNrIGNyZWF0ZWQgdXNlciBmb3IgY2xlYW51cFxuICAgICAgdGhpcy5jcmVhdGVkVXNlcnMucHVzaCh0ZXN0VXNlcik7XG5cbiAgICAgIHJldHVybiB0ZXN0VXNlcjtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVzZXIgY3JlYXRpb24gZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgbXVsdGlwbGUgdGVzdCB1c2Vyc1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlVXNlcnMoY291bnQ6IG51bWJlciwgb3B0aW9uczogQ3JlYXRlVXNlck9wdGlvbnMgPSB7fSk6IFByb21pc2U8VGVzdFVzZXJbXT4ge1xuICAgIGNvbnN0IHVzZXJzOiBUZXN0VXNlcltdID0gW107XG4gICAgXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICBjb25zdCB1c2VyT3B0aW9ucyA9IHtcbiAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgZW1haWw6IG9wdGlvbnMuZW1haWwgPyBgJHtpfS0ke29wdGlvbnMuZW1haWx9YCA6IHVuZGVmaW5lZFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuY3JlYXRlVXNlcih1c2VyT3B0aW9ucyk7XG4gICAgICB1c2Vycy5wdXNoKHVzZXIpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdXNlcnM7XG4gIH1cblxuICAvKipcbiAgICogUmVmcmVzaCBhIHVzZXIncyBhY2Nlc3MgdG9rZW5cbiAgICovXG4gIGFzeW5jIHJlZnJlc2hVc2VyVG9rZW4odXNlcjogVGVzdFVzZXIpOiBQcm9taXNlPFRlc3RVc2VyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuc3VwYWJhc2VDbGllbnQuYXV0aC5yZWZyZXNoU2Vzc2lvbih7XG4gICAgICAgIHJlZnJlc2hfdG9rZW46IHVzZXIucmVmcmVzaFRva2VuXG4gICAgICB9KTtcblxuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVG9rZW4gcmVmcmVzaCBmYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFkYXRhLnNlc3Npb24/LmFjY2Vzc190b2tlbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGFjY2VzcyB0b2tlbiByZWNlaXZlZCBmcm9tIHJlZnJlc2gnKTtcbiAgICAgIH1cblxuICAgICAgLy8gVXBkYXRlIHVzZXIgd2l0aCBuZXcgdG9rZW5zXG4gICAgICB1c2VyLmFjY2Vzc1Rva2VuID0gZGF0YS5zZXNzaW9uLmFjY2Vzc190b2tlbjtcbiAgICAgIHVzZXIucmVmcmVzaFRva2VuID0gZGF0YS5zZXNzaW9uLnJlZnJlc2hfdG9rZW47XG5cbiAgICAgIHJldHVybiB1c2VyO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVG9rZW4gcmVmcmVzaCBmYWlsZWQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIHRlc3QgdXNlclxuICAgKi9cbiAgYXN5bmMgZGVsZXRlVXNlcih1c2VyOiBUZXN0VXNlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCB0aGlzLnN1cGFiYXNlQWRtaW4uYXV0aC5hZG1pbi5kZWxldGVVc2VyKHVzZXIuaWQpO1xuICAgICAgXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gZGVsZXRlIHVzZXIgJHt1c2VyLmlkfTpgLCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVtb3ZlIGZyb20gdHJhY2tpbmdcbiAgICAgIHRoaXMuY3JlYXRlZFVzZXJzID0gdGhpcy5jcmVhdGVkVXNlcnMuZmlsdGVyKHUgPT4gdS5pZCAhPT0gdXNlci5pZCk7XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gZGVsZXRlIHVzZXIgJHt1c2VyLmlkfTpgLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuIHVwIGFsbCBjcmVhdGVkIHVzZXJzXG4gICAqL1xuICBhc3luYyBjbGVhbnVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnNvbGUubG9nKGDwn6e5IENsZWFuaW5nIHVwICR7dGhpcy5jcmVhdGVkVXNlcnMubGVuZ3RofSB0ZXN0IHVzZXJzLi4uYCk7XG4gICAgXG4gICAgY29uc3QgZGVsZXRlUHJvbWlzZXMgPSB0aGlzLmNyZWF0ZWRVc2Vycy5tYXAodXNlciA9PiB0aGlzLmRlbGV0ZVVzZXIodXNlcikpO1xuICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChkZWxldGVQcm9taXNlcyk7XG4gICAgXG4gICAgdGhpcy5jcmVhdGVkVXNlcnMgPSBbXTtcbiAgICBjb25zb2xlLmxvZygn4pyFIFVzZXIgY2xlYW51cCBjb21wbGV0ZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIGNyZWF0ZWQgdXNlcnNcbiAgICovXG4gIGdldENyZWF0ZWRVc2VycygpOiBUZXN0VXNlcltdIHtcbiAgICByZXR1cm4gWy4uLnRoaXMuY3JlYXRlZFVzZXJzXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSB1c2VyIHdpdGggc3BlY2lmaWMgd2FsbGV0IGJhbGFuY2VzXG4gICAqL1xuICBhc3luYyBjcmVhdGVVc2VyV2l0aEJhbGFuY2UoXG4gICAgZXVyQmFsYW5jZTogbnVtYmVyID0gMTAwMCxcbiAgICBhb2FCYWxhbmNlOiBudW1iZXIgPSA1MDAwMDAsXG4gICAgb3B0aW9uczogQ3JlYXRlVXNlck9wdGlvbnMgPSB7fVxuICApOiBQcm9taXNlPFRlc3RVc2VyPiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuY3JlYXRlVXNlcihvcHRpb25zKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBDcmVhdGUgd2FsbGV0cyB3aXRoIGluaXRpYWwgYmFsYW5jZXNcbiAgICAgIGF3YWl0IHRoaXMuc3VwYWJhc2VBZG1pblxuICAgICAgICAuZnJvbSgnd2FsbGV0cycpXG4gICAgICAgIC51cHNlcnQoW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVzZXJfaWQ6IHVzZXIuaWQsXG4gICAgICAgICAgICBjdXJyZW5jeTogJ0VVUicsXG4gICAgICAgICAgICBhdmFpbGFibGVfYmFsYW5jZTogZXVyQmFsYW5jZSxcbiAgICAgICAgICAgIHJlc2VydmVkX2JhbGFuY2U6IDAsXG4gICAgICAgICAgICB0b3RhbF9iYWxhbmNlOiBldXJCYWxhbmNlXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyX2lkOiB1c2VyLmlkLFxuICAgICAgICAgICAgY3VycmVuY3k6ICdBT0EnLFxuICAgICAgICAgICAgYXZhaWxhYmxlX2JhbGFuY2U6IGFvYUJhbGFuY2UsXG4gICAgICAgICAgICByZXNlcnZlZF9iYWxhbmNlOiAwLFxuICAgICAgICAgICAgdG90YWxfYmFsYW5jZTogYW9hQmFsYW5jZVxuICAgICAgICAgIH1cbiAgICAgICAgXSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5KwIENyZWF0ZWQgdXNlciAke3VzZXIuZW1haWx9IHdpdGggRVVSOiAke2V1ckJhbGFuY2V9LCBBT0E6ICR7YW9hQmFsYW5jZX1gKTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBzZXQgd2FsbGV0IGJhbGFuY2VzIGZvciB1c2VyICR7dXNlci5pZH06YCwgZXJyb3IpO1xuICAgIH1cblxuICAgIHJldHVybiB1c2VyO1xuICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCB1c2VyRmFjdG9yeSA9IG5ldyBVc2VyRmFjdG9yeSgpO1xuIl0sInZlcnNpb24iOjN9
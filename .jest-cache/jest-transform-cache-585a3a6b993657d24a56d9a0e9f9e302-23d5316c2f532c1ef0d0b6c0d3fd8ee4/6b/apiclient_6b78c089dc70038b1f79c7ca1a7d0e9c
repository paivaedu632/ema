104a6193f1310330a53c933cd697edfe
"use strict";
/**
 * API Client for Testing
 * Provides utilities for making authenticated API requests in tests
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.apiClient = exports.ApiClient = void 0;
const supertest_1 = __importDefault(require("supertest"));
class ApiClient {
    constructor(baseUrl) {
        this.baseUrl = baseUrl || global.testConfig.apiBaseUrl;
        this.defaultTimeout = global.testConfig.apiTimeout;
    }
    /**
     * Make an authenticated GET request
     */
    async get(endpoint, user, options = {}) {
        return this.makeRequest('GET', endpoint, undefined, user, options);
    }
    /**
     * Make an authenticated POST request
     */
    async post(endpoint, data, user, options = {}) {
        return this.makeRequest('POST', endpoint, data, user, options);
    }
    /**
     * Make an authenticated PUT request
     */
    async put(endpoint, data, user, options = {}) {
        return this.makeRequest('PUT', endpoint, data, user, options);
    }
    /**
     * Make an authenticated DELETE request
     */
    async delete(endpoint, user, options = {}) {
        return this.makeRequest('DELETE', endpoint, undefined, user, options);
    }
    /**
     * Make a request without authentication
     */
    async publicGet(endpoint, options = {}) {
        return this.makeRequest('GET', endpoint, undefined, undefined, options);
    }
    /**
     * Make a request with custom headers
     */
    async requestWithHeaders(method, endpoint, data, headers, options = {}) {
        const customOptions = Object.assign(Object.assign({}, options), { headers: Object.assign(Object.assign({}, options.headers), headers) });
        return this.makeRequest(method, endpoint, data, undefined, customOptions);
    }
    /**
     * Core request method
     */
    async makeRequest(method, endpoint, data, user, options = {}) {
        const startTime = Date.now();
        // Create the request
        let req = (0, supertest_1.default)(this.baseUrl)[method.toLowerCase()](endpoint);
        // Set timeout
        const timeout = options.timeout || this.defaultTimeout;
        req = req.timeout(timeout);
        // Set authentication header
        if (user) {
            req = req.set('Authorization', `Bearer ${user.accessToken}`);
        }
        // Set custom headers
        if (options.headers) {
            Object.entries(options.headers).forEach(([key, value]) => {
                req = req.set(key, value);
            });
        }
        // Set content type for POST/PUT requests
        if ((method === 'POST' || method === 'PUT') && data) {
            req = req.set('Content-Type', 'application/json');
            req = req.send(data);
        }
        try {
            const response = await req;
            const responseTime = Date.now() - startTime;
            // Check expected status if provided
            if (options.expectStatus && response.status !== options.expectStatus) {
                throw new Error(`Expected status ${options.expectStatus} but got ${response.status}. Response: ${JSON.stringify(response.body)}`);
            }
            return {
                status: response.status,
                body: response.body,
                headers: response.headers,
                responseTime
            };
        }
        catch (error) {
            const responseTime = Date.now() - startTime;
            if (error.response) {
                // HTTP error response
                return {
                    status: error.response.status,
                    body: error.response.body,
                    headers: error.response.headers,
                    responseTime
                };
            }
            // Network or other error
            throw new Error(`Request failed: ${error.message}`);
        }
    }
    /**
     * Test endpoint performance
     */
    async testPerformance(method, endpoint, expectedMaxTime, user, data) {
        const response = await this.makeRequest(method, endpoint, data, user);
        const passed = response.responseTime <= expectedMaxTime;
        return { response, passed };
    }
    /**
     * Test concurrent requests
     */
    async testConcurrency(method, endpoint, concurrentRequests, user, data) {
        const promises = Array(concurrentRequests)
            .fill(null)
            .map(() => this.makeRequest(method, endpoint, data, user));
        return Promise.all(promises);
    }
    /**
     * Test with invalid JWT token
     */
    async testWithInvalidToken(method, endpoint, data) {
        const options = {
            headers: {
                'Authorization': 'Bearer invalid-token-12345'
            }
        };
        return this.makeRequest(method, endpoint, data, undefined, options);
    }
    /**
     * Test with expired JWT token
     */
    async testWithExpiredToken(method, endpoint, data) {
        // Create an expired JWT token (this is a mock expired token)
        const expiredToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyMzkwMjJ9.invalid';
        const options = {
            headers: {
                'Authorization': `Bearer ${expiredToken}`
            }
        };
        return this.makeRequest(method, endpoint, data, undefined, options);
    }
    /**
     * Test with malformed authorization header
     */
    async testWithMalformedAuth(method, endpoint, authHeader, data) {
        const options = {
            headers: {
                'Authorization': authHeader
            }
        };
        return this.makeRequest(method, endpoint, data, undefined, options);
    }
}
exports.ApiClient = ApiClient;
// Export singleton instance
exports.apiClient = new ApiClient();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVc2VyXFxEb2N1bWVudHNcXEdpdEh1YlxcZW1hXFx0ZXN0c1xcdXRpbHNcXGFwaS1jbGllbnQudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7Ozs7O0FBRUgsMERBQWdDO0FBZ0JoQyxNQUFhLFNBQVM7SUFJcEIsWUFBWSxPQUFnQjtRQUMxQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQztRQUN2RCxJQUFJLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDO0lBQ3JELENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxHQUFHLENBQ1AsUUFBZ0IsRUFDaEIsSUFBZSxFQUNmLFVBQTZCLEVBQUU7UUFFL0IsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsSUFBSSxDQUNSLFFBQWdCLEVBQ2hCLElBQVUsRUFDVixJQUFlLEVBQ2YsVUFBNkIsRUFBRTtRQUUvQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxHQUFHLENBQ1AsUUFBZ0IsRUFDaEIsSUFBVSxFQUNWLElBQWUsRUFDZixVQUE2QixFQUFFO1FBRS9CLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FDVixRQUFnQixFQUNoQixJQUFlLEVBQ2YsVUFBNkIsRUFBRTtRQUUvQixPQUFPLElBQUksQ0FBQyxXQUFX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O1FBRUYsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0RSxDQUFDO0NBQ0Y7QUFsUEQsOEJBa1BDO0FBRUQsNEJBQTRCO0FBQ2YsUUFBQSxTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVzZXJcXERvY3VtZW50c1xcR2l0SHViXFxlbWFcXHRlc3RzXFx1dGlsc1xcYXBpLWNsaWVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFQSSBDbGllbnQgZm9yIFRlc3RpbmdcbiAqIFByb3ZpZGVzIHV0aWxpdGllcyBmb3IgbWFraW5nIGF1dGhlbnRpY2F0ZWQgQVBJIHJlcXVlc3RzIGluIHRlc3RzXG4gKi9cblxuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCB7IFRlc3RVc2VyIH0gZnJvbSAnLi91c2VyLWZhY3RvcnknO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwaVJlc3BvbnNlPFQgPSBhbnk+IHtcbiAgc3RhdHVzOiBudW1iZXI7XG4gIGJvZHk6IFQ7XG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHJlc3BvbnNlVGltZTogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaVJlcXVlc3RPcHRpb25zIHtcbiAgaGVhZGVycz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHRpbWVvdXQ/OiBudW1iZXI7XG4gIGV4cGVjdFN0YXR1cz86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEFwaUNsaWVudCB7XG4gIHByaXZhdGUgYmFzZVVybDogc3RyaW5nO1xuICBwcml2YXRlIGRlZmF1bHRUaW1lb3V0OiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoYmFzZVVybD86IHN0cmluZykge1xuICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmwgfHwgZ2xvYmFsLnRlc3RDb25maWcuYXBpQmFzZVVybDtcbiAgICB0aGlzLmRlZmF1bHRUaW1lb3V0ID0gZ2xvYmFsLnRlc3RDb25maWcuYXBpVGltZW91dDtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYWtlIGFuIGF1dGhlbnRpY2F0ZWQgR0VUIHJlcXVlc3RcbiAgICovXG4gIGFzeW5jIGdldDxUID0gYW55PihcbiAgICBlbmRwb2ludDogc3RyaW5nLFxuICAgIHVzZXI/OiBUZXN0VXNlcixcbiAgICBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8QXBpUmVzcG9uc2U8VD4+IHtcbiAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdCgnR0VUJywgZW5kcG9pbnQsIHVuZGVmaW5lZCwgdXNlciwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogTWFrZSBhbiBhdXRoZW50aWNhdGVkIFBPU1QgcmVxdWVzdFxuICAgKi9cbiAgYXN5bmMgcG9zdDxUID0gYW55PihcbiAgICBlbmRwb2ludDogc3RyaW5nLFxuICAgIGRhdGE/OiBhbnksXG4gICAgdXNlcj86IFRlc3RVc2VyLFxuICAgIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge31cbiAgKTogUHJvbWlzZTxBcGlSZXNwb25zZTxUPj4ge1xuICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0KCdQT1NUJywgZW5kcG9pbnQsIGRhdGEsIHVzZXIsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ha2UgYW4gYXV0aGVudGljYXRlZCBQVVQgcmVxdWVzdFxuICAgKi9cbiAgYXN5bmMgcHV0PFQgPSBhbnk+KFxuICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgZGF0YT86IGFueSxcbiAgICB1c2VyPzogVGVzdFVzZXIsXG4gICAgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fVxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPFQ+PiB7XG4gICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QoJ1BVVCcsIGVuZHBvaW50LCBkYXRhLCB1c2VyLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYWtlIGFuIGF1dGhlbnRpY2F0ZWQgREVMRVRFIHJlcXVlc3RcbiAgICovXG4gIGFzeW5jIGRlbGV0ZTxUID0gYW55PihcbiAgICBlbmRwb2ludDogc3RyaW5nLFxuICAgIHVzZXI/OiBUZXN0VXNlcixcbiAgICBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8QXBpUmVzcG9uc2U8VD4+IHtcbiAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdCgnREVMRVRFJywgZW5kcG9pbnQsIHVuZGVmaW5lZCwgdXNlciwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogTWFrZSBhIHJlcXVlc3Qgd2l0aG91dCBhdXRoZW50aWNhdGlvblxuICAgKi9cbiAgYXN5bmMgcHVibGljR2V0PFQgPSBhbnk+KFxuICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7fVxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPFQ+PiB7XG4gICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QoJ0dFVCcsIGVuZHBvaW50LCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogTWFrZSBhIHJlcXVlc3Qgd2l0aCBjdXN0b20gaGVhZGVyc1xuICAgKi9cbiAgYXN5bmMgcmVxdWVzdFdpdGhIZWFkZXJzPFQgPSBhbnk+KFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgZGF0YT86IGFueSxcbiAgICBoZWFkZXJzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgICBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8QXBpUmVzcG9uc2U8VD4+IHtcbiAgICBjb25zdCBjdXN0b21PcHRpb25zID0ge1xuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIGhlYWRlcnM6IHsgLi4ub3B0aW9ucy5oZWFkZXJzLCAuLi5oZWFkZXJzIH1cbiAgICB9O1xuICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0KG1ldGhvZCwgZW5kcG9pbnQsIGRhdGEsIHVuZGVmaW5lZCwgY3VzdG9tT3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogQ29yZSByZXF1ZXN0IG1ldGhvZFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBtYWtlUmVxdWVzdDxUID0gYW55PihcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBlbmRwb2ludDogc3RyaW5nLFxuICAgIGRhdGE/OiBhbnksXG4gICAgdXNlcj86IFRlc3RVc2VyLFxuICAgIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge31cbiAgKTogUHJvbWlzZTxBcGlSZXNwb25zZTxUPj4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgLy8gQ3JlYXRlIHRoZSByZXF1ZXN0XG4gICAgbGV0IHJlcSA9IHJlcXVlc3QodGhpcy5iYXNlVXJsKVttZXRob2QudG9Mb3dlckNhc2UoKV0oZW5kcG9pbnQpO1xuXG4gICAgLy8gU2V0IHRpbWVvdXRcbiAgICBjb25zdCB0aW1lb3V0ID0gb3B0aW9ucy50aW1lb3V0IHx8IHRoaXMuZGVmYXVsdFRpbWVvdXQ7XG4gICAgcmVxID0gcmVxLnRpbWVvdXQodGltZW91dCk7XG5cbiAgICAvLyBTZXQgYXV0aGVudGljYXRpb24gaGVhZGVyXG4gICAgaWYgKHVzZXIpIHtcbiAgICAgIHJlcSA9IHJlcS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dXNlci5hY2Nlc3NUb2tlbn1gKTtcbiAgICB9XG5cbiAgICAvLyBTZXQgY3VzdG9tIGhlYWRlcnNcbiAgICBpZiAob3B0aW9ucy5oZWFkZXJzKSB7XG4gICAgICBPYmplY3QuZW50cmllcyhvcHRpb25zLmhlYWRlcnMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICByZXEgPSByZXEuc2V0KGtleSwgdmFsdWUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gU2V0IGNvbnRlbnQgdHlwZSBmb3IgUE9TVC9QVVQgcmVxdWVzdHNcbiAgICBpZiAoKG1ldGhvZCA9PT0gJ1BPU1QnIHx8IG1ldGhvZCA9PT0gJ1BVVCcpICYmIGRhdGEpIHtcbiAgICAgIHJlcSA9IHJlcS5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgICByZXEgPSByZXEuc2VuZChkYXRhKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXE7XG4gICAgICBjb25zdCByZXNwb25zZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuXG4gICAgICAvLyBDaGVjayBleHBlY3RlZCBzdGF0dXMgaWYgcHJvdmlkZWRcbiAgICAgIGlmIChvcHRpb25zLmV4cGVjdFN0YXR1cyAmJiByZXNwb25zZS5zdGF0dXMgIT09IG9wdGlvbnMuZXhwZWN0U3RhdHVzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRXhwZWN0ZWQgc3RhdHVzICR7b3B0aW9ucy5leHBlY3RTdGF0dXN9IGJ1dCBnb3QgJHtyZXNwb25zZS5zdGF0dXN9LiBSZXNwb25zZTogJHtKU09OLnN0cmluZ2lmeShyZXNwb25zZS5ib2R5KX1gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICBib2R5OiByZXNwb25zZS5ib2R5LFxuICAgICAgICBoZWFkZXJzOiByZXNwb25zZS5oZWFkZXJzLFxuICAgICAgICByZXNwb25zZVRpbWVcbiAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIFxuICAgICAgaWYgKGVycm9yLnJlc3BvbnNlKSB7XG4gICAgICAgIC8vIEhUVFAgZXJyb3IgcmVzcG9uc2VcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXM6IGVycm9yLnJlc3BvbnNlLnN0YXR1cyxcbiAgICAgICAgICBib2R5OiBlcnJvci5yZXNwb25zZS5ib2R5LFxuICAgICAgICAgIGhlYWRlcnM6IGVycm9yLnJlc3BvbnNlLmhlYWRlcnMsXG4gICAgICAgICAgcmVzcG9uc2VUaW1lXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIE5ldHdvcmsgb3Igb3RoZXIgZXJyb3JcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdCBmYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGVzdCBlbmRwb2ludCBwZXJmb3JtYW5jZVxuICAgKi9cbiAgYXN5bmMgdGVzdFBlcmZvcm1hbmNlPFQgPSBhbnk+KFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgZXhwZWN0ZWRNYXhUaW1lOiBudW1iZXIsXG4gICAgdXNlcj86IFRlc3RVc2VyLFxuICAgIGRhdGE/OiBhbnlcbiAgKTogUHJvbWlzZTx7IHJlc3BvbnNlOiBBcGlSZXNwb25zZTxUPjsgcGFzc2VkOiBib29sZWFuIH0+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBlbmRwb2ludCwgZGF0YSwgdXNlcik7XG4gICAgY29uc3QgcGFzc2VkID0gcmVzcG9uc2UucmVzcG9uc2VUaW1lIDw9IGV4cGVjdGVkTWF4VGltZTtcbiAgICBcbiAgICByZXR1cm4geyByZXNwb25zZSwgcGFzc2VkIH07XG4gIH1cblxuICAvKipcbiAgICogVGVzdCBjb25jdXJyZW50IHJlcXVlc3RzXG4gICAqL1xuICBhc3luYyB0ZXN0Q29uY3VycmVuY3k8VCA9IGFueT4oXG4gICAgbWV0aG9kOiBzdHJpbmcsXG4gICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICBjb25jdXJyZW50UmVxdWVzdHM6IG51bWJlcixcbiAgICB1c2VyPzogVGVzdFVzZXIsXG4gICAgZGF0YT86IGFueVxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPFQ+W10+IHtcbiAgICBjb25zdCBwcm9taXNlcyA9IEFycmF5KGNvbmN1cnJlbnRSZXF1ZXN0cylcbiAgICAgIC5maWxsKG51bGwpXG4gICAgICAubWFwKCgpID0+IHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBlbmRwb2ludCwgZGF0YSwgdXNlcikpO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0IHdpdGggaW52YWxpZCBKV1QgdG9rZW5cbiAgICovXG4gIGFzeW5jIHRlc3RXaXRoSW52YWxpZFRva2VuPFQgPSBhbnk+KFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgZGF0YT86IGFueVxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPFQ+PiB7XG4gICAgY29uc3Qgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogJ0JlYXJlciBpbnZhbGlkLXRva2VuLTEyMzQ1J1xuICAgICAgfVxuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBlbmRwb2ludCwgZGF0YSwgdW5kZWZpbmVkLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0IHdpdGggZXhwaXJlZCBKV1QgdG9rZW5cbiAgICovXG4gIGFzeW5jIHRlc3RXaXRoRXhwaXJlZFRva2VuPFQgPSBhbnk+KFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgZGF0YT86IGFueVxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPFQ+PiB7XG4gICAgLy8gQ3JlYXRlIGFuIGV4cGlyZWQgSldUIHRva2VuICh0aGlzIGlzIGEgbW9jayBleHBpcmVkIHRva2VuKVxuICAgIGNvbnN0IGV4cGlyZWRUb2tlbiA9ICdleUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKemRXSWlPaUl4TWpNME5UWTNPRGt3SWl3aWJtRnRaU0k2SWtwdmFHNGdSRzlsSWl3aWFXRjBJam94TlRFMk1qTTVNREl5TENKbGVIQWlPakUxTVRZeU16a3dNako5LmludmFsaWQnO1xuICAgIFxuICAgIGNvbnN0IG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zID0ge1xuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtleHBpcmVkVG9rZW59YFxuICAgICAgfVxuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBlbmRwb2ludCwgZGF0YSwgdW5kZWZpbmVkLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0IHdpdGggbWFsZm9ybWVkIGF1dGhvcml6YXRpb24gaGVhZGVyXG4gICAqL1xuICBhc3luYyB0ZXN0V2l0aE1hbGZvcm1lZEF1dGg8VCA9IGFueT4oXG4gICAgbWV0aG9kOiBzdHJpbmcsXG4gICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICBhdXRoSGVhZGVyOiBzdHJpbmcsXG4gICAgZGF0YT86IGFueVxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPFQ+PiB7XG4gICAgY29uc3Qgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYXV0aEhlYWRlclxuICAgICAgfVxuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBlbmRwb2ludCwgZGF0YSwgdW5kZWZpbmVkLCBvcHRpb25zKTtcbiAgfVxufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXG5leHBvcnQgY29uc3QgYXBpQ2xpZW50ID0gbmV3IEFwaUNsaWVudCgpO1xuIl0sInZlcnNpb24iOjN9